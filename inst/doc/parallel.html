<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Ralf Stubner" />

<meta name="date" content="2019-03-04" />

<title>Parallel RNG usage</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' || rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#header {
text-align: center;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; }  code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>

</head>

<body>




<h1 class="title toc-ignore">Parallel RNG usage</h1>
<h4 class="author"><em>Ralf Stubner</em></h4>
<h4 class="date"><em>2019-03-04</em></h4>



<p>When you want to use random number generators (RNG) for parallel computations, you need to make sure that the sequences of random numbers used by the different processes do not overlap. There are two main approaches to this problem:<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a></p>
<ul>
<li>Partition the complete sequence of random numbers produced for one seed into sub-sequences and assign each process one sub-sequence.</li>
<li>Re-parametrize the generator to produce non-overlapping sequences for the same seed.</li>
</ul>
<p>The RNGs included in <code>dqrng</code> offer at least one of these methods for parallel RNG usage. Currently these features can only be used from C++.</p>
<div id="xoroshiro-jump-ahead-with-openmp" class="section level1">
<h1>Xo(ro)shiro: jump ahead with OpenMP</h1>
<p>The Xoshiro256+ generator has a period of <span class="math inline">\(2^{256} -1\)</span> and offers <span class="math inline">\(2^{128}\)</span> sub-sequences, which are <span class="math inline">\(2^{128}\)</span> random draws apart. The Xoroshiro128+ generator has a period of <span class="math inline">\(2^{128} -1\)</span> and offers <span class="math inline">\(2^{64}\)</span> sub-sequences, which are <span class="math inline">\(2^{64}\)</span> random draws apart. You can go from one sub-sequence to the next using the <code>jump()</code> method and the convenience wrapper <code>jump(int n)</code>, which advances to the <code>n</code>th sub-sequence.</p>
<p>As an example we draw and sum a large number of uniformly distributed numbers. This is done several times using OpenMP for parallelisation. Care has been taken to keep the global RNG <code>rng</code> usable outside of the parallel block.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="co">// [[Rcpp::depends(dqrng)]]</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="pp">#include </span><span class="im">&lt;xoshiro.h&gt;</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="pp">#include </span><span class="im">&lt;dqrng_distribution.h&gt;</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="co">// [[Rcpp::plugins(openmp)]]</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="pp">#include </span><span class="im">&lt;omp.h&gt;</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"></a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="co">// [[Rcpp::export]]</span></a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="bu">std::</span>vector&lt;<span class="dt">double</span>&gt; parallel_random_sum(<span class="dt">int</span> n, <span class="dt">int</span> m, <span class="dt">int</span> ncores) {</a>
<a class="sourceLine" id="cb1-10" data-line-number="10">  dqrng::uniform_distribution dist(<span class="fl">0.0</span>, <span class="fl">1.0</span>); <span class="co">// Uniform distribution [0,1)</span></a>
<a class="sourceLine" id="cb1-11" data-line-number="11">  dqrng::xoshiro256plus rng(<span class="dv">42</span>);              <span class="co">// properly seeded rng</span></a>
<a class="sourceLine" id="cb1-12" data-line-number="12">  <span class="bu">std::</span>vector&lt;<span class="dt">double</span>&gt; res(m);</a>
<a class="sourceLine" id="cb1-13" data-line-number="13">  <span class="co">// ok to use rng here</span></a>
<a class="sourceLine" id="cb1-14" data-line-number="14">  </a>
<a class="sourceLine" id="cb1-15" data-line-number="15">  <span class="pp">#pragma omp parallel num_threads(ncores)</span></a>
<a class="sourceLine" id="cb1-16" data-line-number="16">  {</a>
<a class="sourceLine" id="cb1-17" data-line-number="17">    dqrng::xoshiro256plus lrng(rng);      <span class="co">// make thread local copy of rng </span></a>
<a class="sourceLine" id="cb1-18" data-line-number="18">    lrng.jump(omp_get_thread_num() + <span class="dv">1</span>);  <span class="co">// advance rng by 1 ... ncores jumps</span></a>
<a class="sourceLine" id="cb1-19" data-line-number="19"></a>
<a class="sourceLine" id="cb1-20" data-line-number="20">    <span class="pp">#pragma omp for</span></a>
<a class="sourceLine" id="cb1-21" data-line-number="21">    <span class="cf">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; m; ++i) {</a>
<a class="sourceLine" id="cb1-22" data-line-number="22">      <span class="dt">double</span> lres(<span class="dv">0</span>);</a>
<a class="sourceLine" id="cb1-23" data-line-number="23">      <span class="cf">for</span> (<span class="dt">int</span> j = <span class="dv">0</span>; j &lt; n; ++j) {</a>
<a class="sourceLine" id="cb1-24" data-line-number="24">        lres += dist(lrng);</a>
<a class="sourceLine" id="cb1-25" data-line-number="25">      }</a>
<a class="sourceLine" id="cb1-26" data-line-number="26">      res[i] = lres / n;</a>
<a class="sourceLine" id="cb1-27" data-line-number="27">    }</a>
<a class="sourceLine" id="cb1-28" data-line-number="28">  }</a>
<a class="sourceLine" id="cb1-29" data-line-number="29">  <span class="co">// ok to use rng here</span></a>
<a class="sourceLine" id="cb1-30" data-line-number="30">  <span class="cf">return</span> res;</a>
<a class="sourceLine" id="cb1-31" data-line-number="31">}</a>
<a class="sourceLine" id="cb1-32" data-line-number="32"></a>
<a class="sourceLine" id="cb1-33" data-line-number="33"><span class="co">/*** R</span></a>
<a class="sourceLine" id="cb1-34" data-line-number="34"><span class="co">parallel_random_sum(1e7, 8, 4)</span></a>
<a class="sourceLine" id="cb1-35" data-line-number="35"><span class="co">*/</span></a></code></pre></div>
<p>Result:</p>
<pre><code>[1] 0.4999572 0.5000629 0.5001152 0.4998430 0.5000855 0.5000065 0.5001489 0.4998603</code></pre>
</div>
<div id="pcg-multiple-streams-with-rcppparallel" class="section level1">
<h1>PCG: multiple streams with RcppParallel</h1>
<p>From the PCG family we will look at pcg64, a 64-bit generator with a period of <span class="math inline">\(2^{128}\)</span>. It offers the function <a href="http://www.pcg-random.org/using-pcg-cpp.html#void-advance-state-type-delta"><code>advance(int n)</code></a>, which is equivalent to <code>n</code> random draws but scales as <span class="math inline">\(O(ln(n))\)</span> instead of <span class="math inline">\(O(n)\)</span>. In addition, it offers <span class="math inline">\(2^{127}\)</span> separate streams that can be enabled via the function <a href="http://www.pcg-random.org/using-pcg-cpp.html#void-pcg32-set-stream-state-type-stream"><code>set_stream(int n)</code></a> or the <a href="http://www.pcg-random.org/using-pcg-cpp.html#pcg32-pcg32-constructor">two argument constructor</a> with <code>seed</code> and <code>stream</code>. In the following example a matrix with random numbers is generated in parallel using RcppParallel. The resulting correlation matrix should be close to the identity matrix if the different streams are independent:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="co">// [[Rcpp::depends(dqrng)]]</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="pp">#include </span><span class="im">&lt;pcg_random.hpp&gt;</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="pp">#include </span><span class="im">&lt;dqrng_distribution.h&gt;</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="co">// [[Rcpp::depends(RcppParallel)]]</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="pp">#include </span><span class="im">&lt;RcppParallel.h&gt;</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="co">// [[Rcpp::plugins(cpp11)]]</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="kw">struct</span> RandomFill : <span class="kw">public</span> RcppParallel::Worker {</a>
<a class="sourceLine" id="cb3-10" data-line-number="10">  RcppParallel::RMatrix&lt;<span class="dt">double</span>&gt; output;</a>
<a class="sourceLine" id="cb3-11" data-line-number="11">  <span class="dt">uint64_t</span> seed;</a>
<a class="sourceLine" id="cb3-12" data-line-number="12">  dqrng::normal_distribution dist{<span class="fl">0.0</span>, <span class="fl">1.0</span>};</a>
<a class="sourceLine" id="cb3-13" data-line-number="13"></a>
<a class="sourceLine" id="cb3-14" data-line-number="14">  RandomFill(Rcpp::NumericMatrix output, <span class="at">const</span> <span class="dt">uint64_t</span> seed) : output(output), seed(seed) {};</a>
<a class="sourceLine" id="cb3-15" data-line-number="15"></a>
<a class="sourceLine" id="cb3-16" data-line-number="16">  <span class="dt">void</span> <span class="kw">operator</span>()(<span class="bu">std::</span>size_t begin, <span class="bu">std::</span>size_t end) {</a>
<a class="sourceLine" id="cb3-17" data-line-number="17">    pcg64 rng(seed, end);</a>
<a class="sourceLine" id="cb3-18" data-line-number="18">    <span class="kw">auto</span> gen = <span class="bu">std::</span>bind(dist, <span class="bu">std::</span>ref(rng));</a>
<a class="sourceLine" id="cb3-19" data-line-number="19">    <span class="cf">for</span> (<span class="bu">std::</span>size_t col = begin; col &lt; end; ++col) {</a>
<a class="sourceLine" id="cb3-20" data-line-number="20">      RcppParallel::RMatrix&lt;<span class="dt">double</span>&gt;::Column column = output.column(col);</a>
<a class="sourceLine" id="cb3-21" data-line-number="21">      <span class="bu">std::</span>generate(column.begin(), column.end(), <span class="bu">std::</span>ref(gen));</a>
<a class="sourceLine" id="cb3-22" data-line-number="22">    }</a>
<a class="sourceLine" id="cb3-23" data-line-number="23">  }</a>
<a class="sourceLine" id="cb3-24" data-line-number="24">};</a>
<a class="sourceLine" id="cb3-25" data-line-number="25"></a>
<a class="sourceLine" id="cb3-26" data-line-number="26"><span class="co">// [[Rcpp::export]]</span></a>
<a class="sourceLine" id="cb3-27" data-line-number="27">Rcpp::NumericMatrix parallel_random_matrix(<span class="at">const</span> <span class="dt">int</span> n, <span class="at">const</span> <span class="dt">int</span> m, <span class="at">const</span> <span class="dt">int</span> ncores) {</a>
<a class="sourceLine" id="cb3-28" data-line-number="28">  Rcpp::NumericMatrix res(n, m);</a>
<a class="sourceLine" id="cb3-29" data-line-number="29">  RandomFill randomFill(res, <span class="dv">42</span>);</a>
<a class="sourceLine" id="cb3-30" data-line-number="30">  RcppParallel::parallelFor(<span class="dv">0</span>, m, randomFill, m/ncores + <span class="dv">1</span>);</a>
<a class="sourceLine" id="cb3-31" data-line-number="31">  <span class="cf">return</span> res;</a>
<a class="sourceLine" id="cb3-32" data-line-number="32">}</a>
<a class="sourceLine" id="cb3-33" data-line-number="33"></a>
<a class="sourceLine" id="cb3-34" data-line-number="34"><span class="co">/*** R</span></a>
<a class="sourceLine" id="cb3-35" data-line-number="35"><span class="co">res &lt;- parallel_random_matrix(1e6, 8, 4)</span></a>
<a class="sourceLine" id="cb3-36" data-line-number="36"><span class="co">head(res)</span></a>
<a class="sourceLine" id="cb3-37" data-line-number="37"><span class="co">symnum(x = cor(res), cutpoints = c(0.001, 0.002, 0.999),</span></a>
<a class="sourceLine" id="cb3-38" data-line-number="38"><span class="co">       symbols = c(&quot; &quot;, &quot;?&quot;, &quot;!&quot;, &quot;1&quot;),</span></a>
<a class="sourceLine" id="cb3-39" data-line-number="39"><span class="co">       abbr.colnames = FALSE, corr = TRUE)</span></a>
<a class="sourceLine" id="cb3-40" data-line-number="40"><span class="co">*/</span></a></code></pre></div>
<p>Head of the random matrix:</p>
<pre><code>           [,1]        [,2]        [,3]       [,4]       [,5]       [,6]       [,7]       [,8]
[1,]  0.7114429 -0.19759808 -0.47149983  0.6046378 -0.3709571 -0.8089533  0.8185977 0.49010575
[2,]  0.8721661 -0.47654248  1.10411136 -1.6290995 -1.3276661 -0.2585322 -1.2437521 0.90325167
[3,] -1.4959624  0.61068373 -0.54343828 -0.4623555 -1.1779352 -2.8068283 -0.4341252 1.74490995
[4,]  0.5087201 -0.05175746  0.19007581 -0.7869679  0.9672267 -0.5009787 -0.5283977 1.42487290
[5,] -0.8191448 -0.77348120 -0.03458304  0.7243224  1.0594094 -0.6951184 -0.5456669 0.00894037
[6,]  1.2289518 -2.33539762  0.40222707 -2.3346460 -0.5796549 -0.3092356  2.8961294 0.16773085</code></pre>
<p>Correlation matrix:</p>
<pre><code>[1,] 1              
[2,] ? 1            
[3,]     1          
[4,] ?   ? 1        
[5,]         1      
[6,]       ?   1    
[7,]             1  
[8,]   ?           1
attr(,&quot;legend&quot;)
[1] 0 ‘ ’ 0.001 ‘?’ 0.002 ‘!’ 0.999 ‘1’ 1</code></pre>
<p>So as expected the correlation matrix is almost equal to the identity matrix.</p>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>See for example <a href="http://www.pcg-random.org/posts/critiquing-pcg-streams.html" class="uri">http://www.pcg-random.org/posts/critiquing-pcg-streams.html</a>.<a href="#fnref1" class="footnote-back">↩</a></p></li>
</ol>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
